#!/bin/bash

# Creates fasta_db.csv and fasta_db.index files in <install>/etc/
# Run as a monthly cron job

setDefaults () {
BASE=/opt/@NAME@_@MEMEVER@
BIN=$BASE/bin
LIB=$BASE/lib/perl
ETC=$BASE/etc
LOG=$ETC/update-csv.log
export RSATWS=$BASE/lib/perl/RSATWS

Bacteria=db_genbank_bacteria.csv
Fungi=db_genbank_fungi.csv
Ensembl=db_ensembl.csv
EnsemblAlb=db_ensembl_abinitio.csv
Upstream=db_upstream.csv
Fasta=fasta_db.csv
}

startLog () 
{
touch $LOG
echo `date` " - start update" >> $LOG
}

makeCsvFile () {
# create csv file
$BIN/get_db_csv -db GENBANK -class Bacteria > $ETC/$Bacteria 2>>$LOG
echo "  created $ETC/$Bacteria" >> $LOG

$BIN/get_db_csv -db GENBANK -class Fungi > $ETC/$Fungi 2>>$LOG
echo "  created $ETC/$Fungi" >> $LOG 

$BIN/get_db_csv -db ENSEMBL > $ETC/$Ensembl 2>>$LOG
echo "  created csv file $ETC/$Ensembl" >> $LOG 

$BIN/get_db_csv -db ENSEMBL_ABINITIO > $ETC/$EnsemblAlb 2>>$LOG
echo "  created $ETC/$EnsemblAlb" >> $LOG 

$BIN/get_db_csv -db UPSTREAM > $ETC/$Upstream 2>>$LOG
echo "  created $ETC/$Upstream" >> $LOG 

cat $ETC/db_general.csv $ETC/db_other_genomes.csv $ETC/$Ensembl $ETC/$EnsemblAlb $ETC/$Fungi $ETC/$Bacteria $ETC/$Upstream > $ETC/$Fasta
echo "  created file $ETC/$Fasta" >> $LOG 

}

makeIndexFile () {
# create index file
cd $ETC
if [ -f $ETC/fasta_db.index.new ] ; then
    /bin/rm -f $ETC/fasta_db.index.new
fi

/opt/perl/bin/perl -I $LIB -MCatList -e 'CatList::index_catlist_csv("fasta_db.csv", "fasta_db.index.new")'  >> $LOG 2>>$LOG
/bin/mv -f $ETC/fasta_db.index.new  $ETC/fasta_db.index
}

endLog () {
echo `date` " - end update" >> $LOG 
}

setDefaults 
startLog
makeCsvFile
makeIndexFile
endLog
