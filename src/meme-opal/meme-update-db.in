#!/bin/bash

# update cvs files
UPDATE_CSV=/opt/meme_@MEMEVER@/bin/update-csv.sh

if [ -x $UPDATE_CSV ] ; then
    $UPDATE_CSV
fi

# update db per cvs files
UPDATEDB=/opt/meme_@MEMEVER@/bin/update_db
LOG=/tmp/meme-update-db.log
OPTS="-upstream -noclobber"

# mount nfs partition with fasta databases
ls /opt/meme_@MEMEVER@/db/fasta_databases/ > /dev/null

date > $LOG
if [ -x $UPDATEDB ] ; then
    $UPDATEDB $OPTS >> $LOG 2>&1
fi

# mail log file
MSG=/tmp/meme-message
ATTACH=meme-update-db-`date +%Y-%m-%d`.log.gz
TO=meme@nbcr.net
HOST=`rocks list host attr localhost | grep opal_public_fqdn | awk '{print $3}'`

cat $LOG | gzip > $ATTACH
echo "Update DB log file, run on `date +%Y-%m-%d ` " > $MSG
mailx -r meme@$HOST -s "meme db update on $HOST" -a $ATTACH $TO < $MSG

rm -rf $MSG $ATTACH

